https://mp.weixin.qq.com/s/2NSRe8ehai2ucPo8Tslcbw

#  任务调度平台

mysql 或者 redis 队列存储待执行任务，通过 crontab 定时触发应用完成“捞取、计算、执行等操作”。

1）缺少统一的调度平台导致各业务重复开发；

2）简易版调度实现在任务吞吐、调度时效上缺少保障；

3）业务和调度数据强耦合存储给线上稳定性引入大 key、慢 sql 风险。

开源解决方案如 XXL-Job 、 Elastic-Job、quartz 调度等，但这些都属于进程级调度平台，很难满足更细粒度的业务调用。


### 海量百亿级任务调度平台主要特点和功能，大致如下：

**分布式架构**： 任务调度平台采用分布式架构，可以横向扩展以应对海量任务的调度需求。通过将任务分散到多个节点上执行，提高了系统的吞吐量和稳定性。

**高可靠性**： 平台具有高可靠性，能够保证任务的准确执行。采用主备节点、任务重试机制、任务监控和告警等方式确保任务不会丢失和错过。

**低延迟**： 任务调度平台能够保证低延迟的任务执行。通过优化任务调度算法、减少任务执行的等待时间、提高任务执行的并发度等方式，降低了任务执行的延迟。

**统一管理**： 提供统一的任务管理界面和接口，方便业务方统一管理和监控各类任务。通过可视化界面展示任务执行情况、任务调度状态等信息，提供给用户更直观的操作体验。

**灵活扩展**： 平台具有良好的扩展性，可以根据业务需求灵活定制任务调度策略和调度算法。支持定制化的任务调度器、触发器、任务处理器等组件，满足不同业务场景的需求。

**多样化任务类型**： 平台支持多样化的任务类型，包括定时任务、周期任务、延时任务、异步任务等。能够满足不同业务场景下的任务调度需求。

###  海量亿级任务调度平台解决方案

**统一调度平台**： 搭建统一的任务调度平台，为各业务提供统一的任务调度服务，避免各业务重复开发调度功能，提高开发效率。

**高可靠性设计**： 在平台设计中考虑高可靠性，采用集群部署、主备机制、任务重试、监控告警等方式确保任务执行的稳定性和可靠性。

**低延迟优化**： 优化任务调度算法和执行流程，减少任务调度的等待时间和执行时间，提高任务执行的效率和响应速度。

**解耦业务和调度**： 对业务和调度进行解耦，采用消息队列等方式将任务调度数据存储与业务数据存储分离，降低了业务和调度的耦合性，减少了大 key、慢 SQL 的风险。

**技术选型**： 综合考虑开源解决方案如XXL-Job、Elastic-Job、Quartz等，并结合业务需求和现有技术栈选择合适的调度平台，以满足海量任务调度的需求。
通过以上扩展，海量亿级任务调度平台能够更好地满足业务的高可靠性、低延迟、统一管理等需求，为企业提供稳定可靠的任务调度服务。

### 海量百亿级任务调度平台的功能性诉求
**任务管理**：包括任务注册、任务启停、任务更新等，

**任务查询**：主要用于任务追踪、问题排查、调度统计等，

**任务回调**：由业务提供任务spi回调实现，调度平台定时调用触发

**平台化**：支持多业务接入、百亿级任务注册

**易用性**：自助化接入、运维，使用成本远低自建

**高可靠**：全年 3 个 9 可用性、p99(时延)<1s

**高性能**：支持 100w+TPM 的任务触发

**注册\触发可用性>99.95%**

**任务触达率>99.99%**

**p99(触达延时)<1s**



### 百亿级任务量和百万 TPM 并发的架构方案
**数据存储架构**： 重点解决两个问题**数据可靠**和**海量存储**，可靠的存储保障任务不丢、任务高触达率，鉴于 mysql 在持久化以及 master-slave 部署架构对高可用支持表现，优先选用 mysql 作为底层存储；

但单 DB 在 TPS 性能、数据量上存在瓶颈，这里选用**分库分表**策略，通过增加数据库实例打平数据分布以提升整体性能和存储上限；

**实时性架构**： 类似多级缓存的思路，为保障任务触发时效（p99<1s）这里的设计思路“**任务前置**”，拆解任务触发步骤，将任务捞取、计算工作尽量提前完成，通过毫秒级延迟的**内存时间轮**最终触发，保障任务的触发时效性；

**高并发**： 采用可伸缩架构设计，

1、**存储层尽量拆分为多个逻辑库**，前期通过合并部署降低成本但保留多个逻辑库隔离能力，未来支持快速迁移独立部署以提升性能； 

2、**应用层采用多级调度思路**，按数据分片将大任务拆分成小粒度任务动态根据计算节点数完成分配，实现通过增加计算节点快速提升任务触发能力；

**高可用**： MTTR 分段治理思路，架构层在设计阶段考虑到单点、单机房风险，不管是存储层还是应用层都采用**多机多活**架构，并支持 HA 自动切换大大缩短 MTTF 时效； 立体化的监控+拨测能力，覆盖从注册到触发全流程波动、成功率、耗时、延迟多维度监控，缩短 MTTI 时效；


***MTTR*** 是指 Mean Time to Repair，即**平均修复时间**。 在系统运维和故障处理领域，MTTR 是一个重要的性能指标，用于衡量系统故障发生后，从故障发生到恢复正常运行所花费的平均时间。

MTTR 的计算方式为： **𝑀𝑇𝑇𝑅=总的修复时间/发生故障次数**

MTTR 的值越小越好，因为它反映了系统修复故障的效率和速度。 较低的 MTTR 意味着系统能够更快地从故障中恢复，减少了系统的停机时间，提高了系统的可用性和稳定性。

在实际运维工作中，降低 MTTR 可以通过以下方式实现：
**自动化故障检测和修复**： 引入自动化工具和脚本，实现对常见故障的自动检测和修复，减少人工干预的时间和错误。

**监控和告警系统**： 配置有效的监控系统，及时发现系统异常和故障，通过告警通知运维人员进行快速响应和处理。

**故障排查和诊断**： 提前准备好故障排查的工具和流程，快速定位故障原因，并采取有效的措施进行修复。

***MTTF*** 是指 Mean Time to Failure，即**平均故障间隔时间**。它是指系统或设备在正常使用条件下，平均运行多长时间后出现故障的时间。MTTF 是一个重要的可靠性指标，用于评估系统或设备的可靠性和稳定性。

MTTT 的计算方式为： **MTTF=总的运行时间/发生故障次数**

MTTF 的值越大越好，因为它表示系统或设备在正常运行下的平均故障间隔时间越长，说明系统的可靠性越高。